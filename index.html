<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tracy's Karate - Master Portal</title>
    
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/tracyskarateparmaheights/gateway/main/BLACK-TK.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/tracyskarateparmaheights/gateway/main/BLACK-TK.png">

    <style>
        :root { --gold: #ffcc00; --bg: #1a1a1a; --card: #2b2b2b; --input-bg: #1e1e1e; --green: #2ecc71; --red: #e74c3c; --purple: #9b59b6; --blue: #3498db; --orange: #ff8800; --yellow: #ffff00; --white: #ffffff; --brown: #8b4513; --black: #000000; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg); color: white; margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; box-sizing: border-box; }
        
        .container { background: var(--card); padding: 30px 20px; border-radius: 12px; border-top: 5px solid var(--gold); box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center; width: 100%; max-width: 480px; margin-top: 20px; }
        .logo-img { width: 180px; height: auto; margin-bottom: 10px; }
        
        .nav-header { width: 100%; max-width: 480px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px; }
        
        .video-wrapper { position: relative; width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 20px; border: 1px solid #444; }
        #ytPlayer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        .control-btn { background: var(--gold); color: #000; border: none; padding: 10px 14px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 13px; }
        .belt-header { background: #3d3d3d; padding: 15px; margin-top: 10px; border-radius: 8px; color: var(--gold); cursor: pointer; display: flex; justify-content: space-between; font-weight: bold; }
        .tech-list { max-height: 450px; overflow-y: auto; }
        .tech-btn { background: #222; color: #eee; padding: 14px; margin: 5px 0; border-radius: 6px; border-left: 4px solid var(--gold); width: 100%; cursor: pointer; display: block; text-align: left; font-size: 13px; border:none; }

        input, textarea, select { width: 100%; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #444; background: var(--input-bg); color: white; box-sizing: border-box; font-size: 14px; }
        
        .filter-bar { display: flex; gap: 5px; margin-bottom: 10px; }
        .filter-btn { flex: 1; padding: 8px; background: #333; border: 1px solid #444; color: #888; border-radius: 6px; font-size: 12px; cursor: pointer; }
        .filter-btn.active { background: var(--gold); color: black; border-color: var(--gold); }
        
        /* Prevent selection of text/images */
        * { -webkit-user-select: none; -ms-user-select: none; user-select: none; }
        input, textarea { -webkit-user-select: text; -ms-user-select: text; user-select: text; }
    </style>
</head>
<body oncontextmenu="return false">

    <div class="container" id="loginBox">
        <img src="https://raw.githubusercontent.com/tracyskarateparmaheights/gateway/main/BLACK-TK.png" class="logo-img">
        <h2 style="color: var(--gold); margin: 10px 0 20px 0; font-size: 22px; line-height: 1.2;">Tracy's Karate<br>Master Portal</h2>
        <input type="email" id="emailInput" placeholder="Email">
        <input type="password" id="passInput" placeholder="Password">
        <button id="loginBtn" class="control-btn" style="width:100%; padding:18px;">Sign In</button>
        <div style="margin-top: 25px; font-size: 10px; color: #888; opacity: 0.7; line-height: 1.5;">
            Copyright 2026 by M.D.M. Studios Inc. All Rights Reserved.<br>
            Developed by Directed Route LLC
        </div>
    </div>

    <div class="nav-header" id="portalNav" style="display:none;">
        <div style="display:flex; gap:8px;">
            <button class="control-btn" onclick="stopAndHome()">üè† Menu</button>
        </div>
        <button class="control-btn" onclick="location.reload()" style="background:var(--red); color:white;">Log Out</button>
    </div>

    <div class="container" id="portalView" style="display:none; margin-top:0;">
        <div id="mainMenu">
            <button class="tech-btn" style="padding:25px; text-align:center; font-size:18px;" onclick="openSection('curriculumSection')">ü•ã Video Library</button>
            <button class="tech-btn" style="padding:25px; text-align:center; font-size:18px; display:none;" id="rosterBtn" onclick="openSection('adminDashboard')">üë• Student Roster</button>
        </div>

        <div id="curriculumSection" style="display:none;">
            <div class="video-wrapper"><div id="ytPlayer"></div></div>
            <input type="text" id="videoSearch" placeholder="üîç Search techniques..." onkeyup="searchVideos()" style="margin-bottom:15px;">
            <div id="dynamicCurriculum">
                <p style="text-align:center; color:gray; font-size:12px;">Loading curriculum...</p>
            </div>
        </div>
        
        <div id="adminDashboard" style="display:none;">
            <h3>Student Roster</h3>
            <div id="rosterTableArea"></div>
        </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyC35Ubf6GxyDi3JEiKWaYgVFkYGknMZrcw", 
            authDomain: "tracy-s-karate-portal.firebaseapp.com", 
            projectId: "tracy-s-karate-portal", 
            storageBucket: "tracy-s-karate-portal.appspot.com", 
            messagingSenderId: "338865615783", 
            appId: "1:338865615783:web:75865261864177d46536da" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Expose for migration scripts
        window.dbInstance = db;

        let ytPlayer, currentUserRank = 0, playerIsReady = false;

        // --- PREVENT INSPECT TOOLS ---
        document.addEventListener('keydown', (e) => {
            if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) || (e.ctrlKey && e.keyCode === 85)) {
                e.preventDefault();
            }
        });

        // --- YOUTUBE FUNCTIONS ---
        window.onYouTubeIframeAPIReady = () => {
            ytPlayer = new YT.Player('ytPlayer', {
                height: '100%', width: '100%',
                videoId: '19Ktd4FfDGg',
                playerVars: { 'controls': 1, 'rel': 0, 'modestbranding': 1, 'playsinline': 1 },
                events: { 'onReady': () => { playerIsReady = true; } }
            });
        };

        window.loadVideo = (id) => { if (playerIsReady) { ytPlayer.loadVideoById(id); ytPlayer.playVideo(); } };
        window.stopAndHome = () => { if(playerIsReady) ytPlayer.stopVideo(); window.showMainMenu(); };
        window.toggleGate = (id) => { const el = document.getElementById(id); el.style.display = (el.style.display === "none") ? "block" : "none"; };

        window.showMainMenu = () => {
            document.getElementById('curriculumSection').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'block';
        };

        window.openSection = (id) => {
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById(id).style.display = 'block';
        };

        // --- DATABASE LOADER ---
        const loadCurriculum = async (rank) => {
            const container = document.getElementById('dynamicCurriculum');
            const q = query(collection(db, "curriculum"), where("rankRequired", "<=", rank), orderBy("rankRequired", "asc"));
            
            try {
                const snap = await getDocs(q);
                container.innerHTML = "";
                if(snap.empty) container.innerHTML = "No videos found for your rank.";
                
                snap.forEach(beltDoc => {
                    const data = beltDoc.data();
                    const html = `
                        <div class="belt-group">
                            <div class="belt-header" onclick="window.toggleGate('gate-${beltDoc.id}')">
                                ${data.beltName} <span>‚ñº</span>
                            </div>
                            <div id="gate-${beltDoc.id}" class="tech-list" style="display:none;">
                                ${data.videos.map(v => `<button class="tech-btn" onclick="loadVideo('${v.ytId}')">${v.title}</button>`).join('')}
                            </div>
                        </div>`;
                    container.insertAdjacentHTML('beforeend', html);
                });
            } catch (e) {
                container.innerHTML = "Error loading curriculum.";
            }
        };

        // --- LOGIN ---
        const handleAuth = async () => {
            try {
                const cred = await signInWithEmailAndPassword(auth, document.getElementById('emailInput').value, document.getElementById('passInput').value);
                const snap = await getDoc(doc(db, "users", cred.user.uid));
                if(snap.exists()) {
                    currentUserRank = snap.data().rankLevel || 0;
                    document.getElementById('loginBox').style.display = 'none';
                    document.getElementById('portalNav').style.display = 'flex';
                    document.getElementById('portalView').style.display = 'block';
                    
                    if(currentUserRank >= 14) document.getElementById('rosterBtn').style.display = 'block';
                    
                    await loadCurriculum(currentUserRank);
                }
            } catch(e) { alert("Invalid login credentials."); }
        };

        document.getElementById('loginBtn').onclick = handleAuth;
    </script>
</body>
</html>
